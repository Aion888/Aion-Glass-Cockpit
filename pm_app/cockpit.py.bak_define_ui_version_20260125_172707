from pathlib import Path
from dash import Dash, html, dcc, dash_table



def column_header_row():
    cell = lambda t: html.Div(
        t,
        style={
            "display": "flex",
            "alignItems": "center",
            "justifyContent": "center",
            "textAlign": "center",
            "height": "100%",
            "width": "100%",
        },
    )

    return html.Div(
        style={
            "background": "#f3f4f6",
            "border": "1px solid #e5e7eb",
            "borderRadius": "12px",
            "display": "grid",
            "gridTemplateColumns": "56px 1.6fr 1fr 1fr 1fr 112px",
            "gap": "12px",
            "padding": "6px 0 10px 0",
            "fontSize": "11px",
            "fontWeight": 700,
            "letterSpacing": "0.12em",
            "color": "#94a3b8",
            "textTransform": "uppercase",
        },
        children=[cell("#"), cell(""), cell(""), cell(""), cell(""), cell("")],
    )


def aion_status_label(raw, fallback: str = 'PRE-RACE') -> str:
    """Map a raw race status to a canonical label (safe; no globals required)."""
    states = globals().get('AION_RACE_STATUS_STATES', [])
    key = (raw or '').strip().upper()
    if not key:
        return fallback
    for s in states:
        if (s or '').strip().upper() == key:
            return s
    return fallback

def aion_clean_header_label(s: str) -> str:
    # Remove unwanted legacy label
    return (s or "").replace("RunnerTheoFixedExchange+EV", "").strip()


# fast lookup (case-insensitive)
# Store flags in assets/flags as: flag_AE.png, flag_KR.png, etc.
AION_FLAG_DIR = Path(__file__).resolve().parent.parent / "assets" / "flags"
AION_FLAG_DEFAULT = "flags/flag_HK.png"  # fallback asset path for Dash

def aion_flag_asset(country_code: str | None) -> str:
    """
    Returns the Dash asset path for a flag given an ISO2 code (e.g., 'AE', 'KR').
    Falls back to AION_FLAG_DEFAULT if missing/invalid.
    """
    code = (country_code or "").strip().upper()
    if not code or len(code) != 2:
        return AION_FLAG_DEFAULT

    fname = f"flag_{code}.png"
    if (AION_FLAG_DIR / fname).exists():
        return f"flags/{fname}"

    return AION_FLAG_DEFAULT

import os

def race_btn(n: int):
    # Race number buttons (top header) — +33% size, bold font like upcoming tiles
    return html.Div(
        str(n),
        style={
            "width": "38px",
            "height": "38px",
            "borderRadius": "10px",
            "border": "1px solid #e5e7eb",
            "background": "#ffffff",
            "display": "flex",
            "alignItems": "center",
            "justifyContent": "center",
            "fontSize": "11px",
            "fontWeight": 950,
            "letterSpacing": "0.08em",
            "color": "#111827",
            "boxShadow": "0 2px 6px rgba(0,0,0,0.05)",
            "cursor": "pointer",
            "userSelect": "none",
        },
    )


def runner_btn(n: int):
    return html.Button(
        str(n),
        style={
            "width": "44px",
            "height": "44px",
            "borderRadius": "12px",
            "border": "1px solid #e5e7eb",
            "background": "#ffffff",
            "color": "#0f172a",
            "fontWeight": 900,
            "fontSize": "14px",
            "lineHeight": "44px",
            "padding": "0",
            "cursor": "pointer",
        },
    )

def weather_icon():
    return html.Div(
        "☀︎",
        title="Weather (placeholder)",
        style={
            "width": "40px",
            "height": "40px","width":"80px",
            "borderRadius": "10px",
            "border": "1px solid #e5e7eb",
            "display":"flex","justifyContent":"center",
            "alignItems": "center",
            "justifyContent": "center",
            "fontSize": "18px",
            "color": "#475569",
        },
    )
def aion_ellipsis(s: str | None, max_len: int = 24) -> str:
    s = "" if s is None else str(s)
    if max_len <= 0:
        return ""
    if len(s) <= max_len:
        return s
    # use a single ellipsis char
    return s[: max_len - 1] + "…"
# __AION_UPCOMING_RACES__
# Placeholder feed. Later this becomes your upcoming race data module.
upcoming_races = [
    {"country_code": "HK", "track_code": "SHAT", "race_no": 1, "ttm_min": 18},
    {"country_code": "AE", "track_code": "MEYD", "race_no": 3, "ttm_min": 42},
    {"country_code": "GB", "track_code": "ASCOT", "race_no": 6, "ttm_min": 61},
    {"country_code": "FR", "track_code": "DEAUV", "race_no": 2, "ttm_min": 77},
]

def aion_track_code(code: str | None, n: int = 5) -> str:
    s = "" if code is None else str(code).upper().strip()
    return (s[:n]).ljust(min(n, 5)) if s else "-----"

def aion_ttm_label(ttm_min) -> str:
    try:
        m = float(ttm_min)
    except Exception:
        return ""
    if m < 0:
        return "OFF"
    if m < 1:
        return "<1m"
    return f"{int(round(m))}m"

AION_TILE_STYLE = {
    "width": "80px",
    "minWidth": "80px",
    "paddingRight": "54px",
    "position": "relative",
    "minWidth":"111px",
    "height":"34px",
    "borderRadius": "14px",
    "border": "1px solid #e5e7eb",
    "background": "#f8fafc",
    "padding":"6px 10px",
    "boxShadow": "0 6px 18px rgba(0,0,0,0.06)",
    "display": "flex",
    "flexDirection": "column",
    "justifyContent": "center",
}

def aion_upcoming_tile(r: dict):
    cc = (r.get("country_code") or "HK").upper()
    trk = aion_track_code(r.get("track_code") or "-----", 5)
    rn = r.get("race_no", "")
    ttm = aion_ttm_label(r.get("ttm_min"))

    return html.Div(
        style=AION_TILE_STYLE,
        children=[
            # flag top-right
            html.Img(
                src=app.get_asset_url(aion_flag_asset(cc)),
                style={
                    "position": "absolute",
                    "top":"7px",
                    "right": "8px",
                    "height":"22px",
                    "width":"40px",
                    "borderRadius": "4px",
                    "objectFit": "contain",
                    "boxShadow": "0 2px 6px rgba(0,0,0,0.12)",
                    "background": "transparent",
                },
            ),
            html.Div(
                f"{trk}  R{rn}",
                style={
                    "fontSize":"11px",
                    "fontWeight": 950,
                    "letterSpacing": "0.08em",
                    "color": "#111827",
                    "lineHeight": "1.1",
                },
            ),
            html.Div(
                f"{ttm}" if ttm else "",
                style={
                    "marginTop": "4px",
                    "fontSize": "12px",
                    "fontWeight": 900,
                    "letterSpacing": "0.10em",
                    "color": "#2563eb",
                },
            ),
        ],
    )

# __AION_UPCOMING_PAD__
AION_UPCOMING_MAX = 6

def aion_upcoming_pad(rows, n: int = AION_UPCOMING_MAX):
    rows = list(rows or [])[:n]
    # pad with placeholders to keep layout aligned (design mode)
    while len(rows) < n:
        rows.append({
            "country_code": "HK",
            "track_code": "-----",
            "race_no": "-",
            "ttm_min": None,
        })
    return rows

import os
# --- AION APP BOOTSTRAP ---
AION_ROOT = Path(__file__).resolve().parent.parent
AION_ASSETS = str(AION_ROOT / 'assets')
app = Dash(__name__, assets_folder=AION_ASSETS)
app.title = 'Project Aion — Glass Cockpit'

# __AION_DEFAULTS__ (safe placeholders until live feed is wired)
country_code = globals().get('country_code', 'HK')
track_name    = globals().get('track_name', 'SHA TIN')
race_status   = globals().get('race_status', 'PRE-RACE')
race_type     = globals().get('race_type', 'TB')
upcoming_races = globals().get('upcoming_races', [
    {'country_code':'HK','track_code':'SHAT','race_no':1,'ttm_min':12},
    {'country_code':'HK','track_code':'SHAT','race_no':2,'ttm_min':28},
    {'country_code':'HK','track_code':'SHAT','race_no':3,'ttm_min':44},
    {'country_code':'HK','track_code':'SHAT','race_no':4,'ttm_min':60},
    {'country_code':'HK','track_code':'SHAT','race_no':5,'ttm_min':78},
    {'country_code':'HK','track_code':'SHAT','race_no':6,'ttm_min':95},
])




app.layout = html.Div(
    style={
        "background": "#f6f7fb",
        "minHeight": "100vh",
        "fontFamily": "system-ui",
        "paddingBottom": "72px",
    },
    children=[
        # ================= HEADER REALM =================
        html.Div(
            style={
                "background": "#ffffff",
                "borderRadius": "24px",
                "minHeight": "180px",
                "padding": "12px 28px 16px 28px",
                "margin": "16px",
                "boxShadow": "0 10px 26px rgba(0,0,0,0.08)",
            },
            children=[
                html.Div(
                    style={
                        "display": "flex",
                        "alignItems": "center",
                        "justifyContent": "space-between",
                        "flexWrap": "nowrap",
                    },
                    children=[
                        html.Div(
                            style={"display": "flex", "alignItems": "center", "gap": "10px"},
                            children=[
                                html.Div("", style={"fontSize": "34px"}),
                                html.Div([html.Div(html.Img(src=app.get_asset_url(aion_flag_asset(country_code)), style={"height":"100%","width":"100%","objectFit":"cover","display":"block"}), style={"marginLeft":"-14px","height":"28px","width":"56px","borderRadius":"6px","marginRight":"10px","boxShadow":"0 2px 8px rgba(0,0,0,0.18)","overflow":"hidden","display":"inline-block"})], style={"color":"#2563eb","fontWeight":900,"display":"flex","alignItems":"center","gap":"6px","lineHeight":"28px"}),
                                html.Div(aion_ellipsis(track_name, 18), style={"fontSize":"22px","fontWeight":950,"width":"18ch","flex":"0 0 18ch","whiteSpace":"nowrap","overflow":"hidden","textOverflow":"ellipsis","display":"block","minWidth":0}),
                                weather_icon(),
                                html.Div(
                                    style={"display": "flex", "gap": "6px"},
                                    children=[race_btn(i) for i in range(1, 11)],
                                ),
                            ],
                        ),
                        html.Div(
                            # Right cluster: Upcoming tiles (left) + Race Status/Version (right)
                            style={'display':'flex','alignItems':'center','justifyContent':'flex-end','gap':'24px','minWidth':0},
                            children=[
                            html.Div(
                                # Upcoming races (max 6) — pinned immediately left of status/version
                                style={
                                    'display':'flex',
                                    'paddingLeft':'12px',
                                    'paddingRight':'16px',
                                    'gap':'8px',
                                    'alignItems':'center',
                                    'justifyContent':'flex-start',
                                    'minWidth':0,
                                    'overflowX':'auto',
                                    'overflowY':'hidden',
                                    'whiteSpace':'nowrap',
                                    'WebkitOverflowScrolling':'touch',
        'maxWidth':'980px',
        'flex':'0 1 980px',
                                },
                                children=[aion_upcoming_tile(r) for r in aion_upcoming_pad((upcoming_races or []), 6)],
                            ),
                            html.Div(
                                style={'display':'flex','flexDirection':'column','alignItems':'center','justifyContent':'center','gap':'2px'},
                                children=[
                                html.Div(aion_status_label(globals().get('race_status', None)), style={'fontSize':'14px','fontWeight':900,'letterSpacing':'0.14em','color':'#2563eb','textAlign':'center'}),
                                html.Div(AION_UI_VERSION, style={'fontSize':'12px','fontWeight':800,'letterSpacing':'0.06em','color':'#6b7280','textAlign':'center'}),
                                ],
                            ),
                            ],
                        ),
                    ],
                ),
            ],
        ),


        # ================= RUNNER REALM =================
        html.Div(
            style={
                "background": "#ffffff",
                "margin": "0 16px",
                "borderRadius": "18px",
                "padding": "12px 16px 16px 16px",
                "boxShadow": "0 6px 18px rgba(0,0,0,0.05)",
            },
            children=[
                # Step 3 — column header row
                column_header_row(),

                # Runner rows (placeholders only)
                *[
                    html.Div(
                        style={
                            "display": "grid",
                            "gridTemplateColumns": "56px 1.6fr 1fr 1fr 1fr 112px",
                            "gap": "12px",
                            "padding": "10px 0",
                        },
                        children=[
                            html.Div(
                                runner_btn(i),
                                style={
                                    "display": "flex",
                                    "alignItems": "center",
                                    "justifyContent": "center",
                                },
                            ),
                            "", "", "", "", "",
                        ],
                    )
                    for i in range(1, 15)
                ],
            ],
        ),

        # ================= FIXED BOTTOM BAR =================
        html.Div(
            style={
                "position": "fixed",
                "bottom": "0",
                "left": "0",
                "right": "0",
                "height": "64px",
                "background": "#ffffff",
                "borderTop": "1px solid #e5e7eb",
                "display": "flex",
                "alignItems": "center",
                "justifyContent": "flex-end",
                "padding": "0 24px",
            },
            children=[
                html.Div("AION CONTROL BAR (buttons later)", style={"color": "#64748b"}),
            ],
        ),
    ],
)

# ================= RUN COCKPIT =================
if __name__ == "__main__":
    app.run(host="127.0.0.1", port=8051, debug=False)
