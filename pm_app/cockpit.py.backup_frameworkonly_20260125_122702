from dash import Dash, Input, Output, dash_table, dcc, html
import pandas as pd
import os
import time

app = Dash(__name__)
app.title = "Project Aion — Glass Cockpit"
server = app.server

DATA_CSV = os.path.join(os.path.dirname(__file__), "..", "charter_live.csv")
DATA_CSV = os.path.abspath(DATA_CSV)

def load_df():
    if os.path.exists(DATA_CSV):
        df = pd.read_csv(DATA_CSV)
    else:
        df = pd.DataFrame([{"Info": f"Missing {DATA_CSV}"}])

    if "RunnerTheoFixedExchange+EV" in df.columns:
        df = df.rename(columns={"RunnerTheoFixedExchange+EV": "RunnerTheo + EV"})

    num_cols = df.select_dtypes(include="number").columns.tolist()
    if num_cols:
        totals = {c: df[c].sum() for c in num_cols}
        row = {c: "" for c in df.columns}
        row[df.columns[0]] = "TOTAL"
        row.update(totals)
        df = pd.concat([df, pd.DataFrame([row])], ignore_index=True)

    return df

def build_stamp():
    try:
        mtime = os.path.getmtime(__file__)
        stamp = f"{os.path.basename(__file__)} • {time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(mtime))}"
    except Exception:
        stamp = "unknown"
    return html.Div(
        f"BUILD: {stamp}",
        style={
            "position": "fixed",
            "bottom": "6px",
            "right": "10px",
            "zIndex": 9999,
            "fontFamily": "Arial",
            "fontSize": "11px",
            "opacity": 0.7,
            "background": "rgba(255,255,255,0.9)",
            "padding": "3px 8px",
            "borderRadius": "10px",
            "border": "1px solid #ddd",
        },
    )

app.layout = html.Div(
    style={"fontFamily": "Arial", "padding": "18px", "background": "#f6f7f9", "minHeight": "100vh"},
    children=[
        html.Div(
            [
                html.Div("Project Aion — Glass Cockpit", style={"fontSize": "22px", "fontWeight": "700"}),
                html.Div(f"Data source: {DATA_CSV}", style={"opacity": 0.7, "marginTop": "4px", "fontSize": "12px"}),
            ],
            style={"marginBottom": "12px"},
        ),

        html.Div(
            [
                html.Button("Refresh", id="btn-refresh", n_clicks=0),
                html.Span("  (refresh reloads charter_live.csv)", style={"opacity": 0.65, "fontSize": "12px"}),
            ],
            style={"marginBottom": "10px"},
        ),

        dcc.Store(id="store-df"),
        dcc.Interval(id="interval-once", interval=250, n_intervals=0, max_intervals=1),

        html.Div(
            id="table-wrap",
            style={
                "border": "1px solid #ddd",
                "borderRadius": "14px",
                "padding": "12px",
                "boxShadow": "0 2px 10px rgba(0,0,0,0.06)",
                "background": "white",
            },
        ),

        build_stamp(),
    ],
)

@app.callback(
    Output("store-df", "data"),
    [Input("interval-once", "n_intervals"), Input("btn-refresh", "n_clicks")],
)
def _load(_n, _clicks):
    df = load_df()
    return {"columns": list(df.columns), "records": df.to_dict("records")}

@app.callback(
    Output("table-wrap", "children"),
    Input("store-df", "data"),
)
def _render(data):
    if not data:
        return html.Div("Loading…")

    cols = data["columns"]
    records = data["records"]
    last_row_idx = len(records) - 1 if records else -1

    return dash_table.DataTable(
        columns=[{"name": c, "id": c} for c in cols],
        data=records,
        page_size=50,
        fixed_rows={"headers": True},
        style_table={"maxHeight": "72vh", "overflowY": "auto"},
        style_cell={
            "padding": "6px",
            "whiteSpace": "normal",
            "height": "auto",
            "fontFamily": "Arial",
            "fontSize": "13px",
        },
        style_header={
            "fontWeight": "700",
            "borderBottom": "2px solid #333",
            "backgroundColor": "#f0f2f5",
        },
        style_data_conditional=[
            {
                "if": {"row_index": last_row_idx},
                "fontWeight": "700",
                "borderTop": "2px solid #333",
                "backgroundColor": "#fafafa",
            }
        ] if last_row_idx >= 0 else [],
    )

if __name__ == "__main__":
    app.run(host="127.0.0.1", port=8051, debug=False)
