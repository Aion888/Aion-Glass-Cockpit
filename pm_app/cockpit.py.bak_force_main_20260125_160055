country_code = "HK"
track_name = "SHA TIN"
race_status = 'PRE-RACE'

# __AION_PULSE_STATUS__
AION_RACE_STATUS_STATES = [
    "PRE-RACE",
    "Early Market",
    "Mid Market",
    "Late Market",
    "Behind the Gate",
    "Moving in",
    "First Horse In",
    "Loading",
    "6TG",
    "5TG",
    "4TG",
    "3TG",
    "2TG",
    "1TG",
    "LAST HORSE IN",
    "RACE JUMPED",
    "DELAY",
    "INTERIM",
    "PROTEST",
    "FINAL",
]

_AION_STATUS_MAP = {s.strip().upper(): s for s in AION_RACE_STATUS_STATES}

def aion_status_label(raw, fallback: str = "PRE-RACE") -> str:
    key = (raw or "").strip().upper()
    return _AION_STATUS_MAP.get(key, fallback)


AION_UI_VERSION = "20260125_V01"
race_type = "TB"
# __AION_FLAG_HELPER__
from pathlib import Path as _Path


# fast lookup (case-insensitive)
# Store flags in assets/flags as: flag_AE.png, flag_KR.png, etc.
AION_FLAG_DIR = _Path(__file__).resolve().parent.parent / "assets" / "flags"
AION_FLAG_DEFAULT = "flags/flag_HK.png"  # fallback asset path for Dash

def aion_flag_asset(country_code: str | None) -> str:
    """
    Returns the Dash asset path for a flag given an ISO2 code (e.g., 'AE', 'KR').
    Falls back to AION_FLAG_DEFAULT if missing/invalid.
    """
    code = (country_code or "").strip().upper()
    if not code or len(code) != 2:
        return AION_FLAG_DEFAULT

    fname = f"flag_{code}.png"
    if (AION_FLAG_DIR / fname).exists():
        return f"flags/{fname}"

    return AION_FLAG_DEFAULT

import os
def column_header_row():
    return html.Div(
        style={
            "display": "grid",
            "gridTemplateColumns": "56px 1.6fr 1fr 1fr 1fr 112px",
            "gap": "12px",
            "padding": "6px 0 10px 0",
            "fontSize": "11px",
            "fontWeight": 700,
            "letterSpacing": "0.12em",
            "color": "#94a3b8",
            "textTransform": "uppercase",
        },
        children=["", "Runner", "Theo", "Fixed", "Exchange", "+EV"],
    )
from dash import Dash, html

app = Dash(__name__, assets_folder=os.path.abspath(os.path.join(os.path.dirname(__file__), "..", "assets")))
app.title = "Project Aion — Glass Cockpit"

def race_btn(n: int):
    return html.Button(
        str(n),
        style={
            "width": "34px",
            "height": "34px",
            "borderRadius": "8px",
            "border": "1px solid #e5e7eb",
            "background": "#ffffff",
            "color": "#334155",
            "fontWeight": 800,
            "fontSize":"10px",
            "lineHeight": "34px",
            "padding": "0",
            "cursor": "pointer",
        },
    )

def runner_btn(n: int):
    return html.Button(
        str(n),
        style={
            "width": "44px",
            "height": "44px",
            "borderRadius": "12px",
            "border": "1px solid #e5e7eb",
            "background": "#ffffff",
            "color": "#0f172a",
            "fontWeight": 900,
            "fontSize": "14px",
            "lineHeight": "44px",
            "padding": "0",
            "cursor": "pointer",
        },
    )

def weather_icon():
    return html.Div(
        "☀︎",
        title="Weather (placeholder)",
        style={
            "width": "40px",
            "height": "40px","width":"80px",
            "borderRadius": "10px",
            "border": "1px solid #e5e7eb",
            "display":"flex","justifyContent":"center",
            "alignItems": "center",
            "justifyContent": "center",
            "fontSize": "18px",
            "color": "#475569",
        },
    )

def column_header_row():
    return html.Div(
        style={
            "display": "grid",
            "gridTemplateColumns": "56px 1.6fr 1fr 1fr 1fr 112px",
            "gap": "12px",
            "padding": "6px 0 10px 0",
            "fontSize": "11px",
            "fontWeight": 700,
            "letterSpacing": "0.12em",
            "color": "#94a3b8",
            "textTransform": "uppercase",
        },
        children=["", "Runner", "Theo", "Fixed", "Exchange", "+EV"],
    )
# __AION_ELLIPSIS_HELPER__
def aion_ellipsis(s: str | None, max_len: int = 24) -> str:
    s = "" if s is None else str(s)
    if max_len <= 0:
        return ""
    if len(s) <= max_len:
        return s
    # use a single ellipsis char
    return s[: max_len - 1] + "…"
# __AION_UPCOMING_RACES__
# Placeholder feed. Later this becomes your upcoming race data module.
upcoming_races = [
    {"country_code": "HK", "track_code": "SHAT", "race_no": 1, "ttm_min": 18},
    {"country_code": "AE", "track_code": "MEYD", "race_no": 3, "ttm_min": 42},
    {"country_code": "GB", "track_code": "ASCOT", "race_no": 6, "ttm_min": 61},
    {"country_code": "FR", "track_code": "DEAUV", "race_no": 2, "ttm_min": 77},
]

def aion_track_code(code: str | None, n: int = 5) -> str:
    s = "" if code is None else str(code).upper().strip()
    return (s[:n]).ljust(min(n, 5)) if s else "-----"

def aion_ttm_label(ttm_min) -> str:
    try:
        m = float(ttm_min)
    except Exception:
        return ""
    if m < 0:
        return "OFF"
    if m < 1:
        return "<1m"
    return f"{int(round(m))}m"

AION_TILE_STYLE = {
    "position": "relative",
    "minWidth":"111px",
    "height":"34px",
    "borderRadius": "14px",
    "border": "1px solid #e5e7eb",
    "background": "#f8fafc",
    "padding":"6px 10px",
    "boxShadow": "0 6px 18px rgba(0,0,0,0.06)",
    "display": "flex",
    "flexDirection": "column",
    "justifyContent": "center",
}


# ================= UPCOMING RACE TILE HELPERS =================
def aion_track5(raw) -> str:
    s = (raw or "").strip().upper()
    if not s:
        return "-----"
    return s[:5]

def aion_tminus_label(raw) -> str:
    """
    Accepts: "T-18m", "18m", 18, 18.0, etc. Returns: "18m" (no "T-").
    """
    if raw is None:
        return "—"
    if isinstance(raw, (int, float)):
        return f"{int(raw)}m"
    s = str(raw).strip()
    # strip common T-minus prefixes
    for pref in ("T-", "T–", "T−", "T -", "T –", "T −"):
        if s.startswith(pref):
            s = s[len(pref):].strip()
            break
    return s

def aion_upcoming_tile(r: dict):
    r = r or {}
    country_code = (r.get("country_code") or r.get("cc") or "HK")
    track_raw    = (r.get("track_code") or r.get("track") or "SHA TIN")
    race_no      = (r.get("race_no") or r.get("race") or "1")
    tminus_raw   = (r.get("tminus") or r.get("t_minus") or r.get("t") or "18m")

    track5 = aion_track5(track_raw.replace(" ", ""))  # remove spaces, enforce 5 chars
    tminus = aion_tminus_label(tminus_raw)

    # Flag: double-size rectangle
    flag_style = {
        "height": "24px",
        "width": "36px",
        "borderRadius": "6px",
        "objectFit": "contain",
        "boxShadow": "0 2px 6px rgba(0,0,0,0.14)",
        "flex": "0 0 auto",
    }

    return html.Div(
        style={
            "border": "1px solid rgba(15, 23, 42, 0.10)",
            "borderRadius": "12px",
            "padding": "8px 10px",
            "minWidth": "96px",
            "background": "#ffffff",
            "boxShadow": "0 8px 18px rgba(0,0,0,0.05)",
        },
        children=[
            html.Div(
                style={"display":"flex","alignItems":"center","justifyContent":"space-between","gap":"10px"},
                children=[
                    html.Div(
                        f"{track5} R{race_no}",
                        style={"fontSize":"11px","fontWeight":950,"letterSpacing":"0.06em","color":"#0f172a","whiteSpace":"nowrap"},
                    ),
                    html.Img(src=app.get_asset_url(aion_flag_asset(country_code)), style=flag_style),
                ],
            ),
            html.Div(
                tminus,
                style={"marginTop":"4px","fontSize":"12px","fontWeight":950,"color":"#2563eb","whiteSpace":"nowrap"},
            ),
        ],
    )

