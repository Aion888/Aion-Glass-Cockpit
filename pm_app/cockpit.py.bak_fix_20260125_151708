country_code = "HK"
track_name = "SHA TIN"
race_status = 'PRE-RACE'

# __AION_PULSE_STATUS__
AION_RACE_STATUS_STATES = [
    "PRE-RACE",
    "Early Market",
    "Mid Market",
    "Late Market",
    "Behind the Gate",
    "Moving in",
    "First Horse In",
    "Loading",
    "6TG",
    "5TG",
    "4TG",
    "3TG",
    "2TG",
    "1TG",
    "LAST HORSE IN",
    "RACE JUMPED",
    "DELAY",
    "INTERIM",
    "PROTEST",
    "FINAL",
]

_AION_STATUS_MAP = {s.strip().upper(): s for s in AION_RACE_STATUS_STATES}

def aion_status_label(raw: str | None, fallback: str = "PRE-RACE") -> str:
    key = (raw or "").strip().upper()
    return _AION_STATUS_MAP.get(key, fallback)


AION_UI_VERSION = "20260125_V01"
race_type = "TB"
# __AION_FLAG_HELPER__
from pathlib import Path as _Path


# fast lookup (case-insensitive)
# Store flags in assets/flags as: flag_AE.png, flag_KR.png, etc.
AION_FLAG_DIR = _Path(__file__).resolve().parent.parent / "assets" / "flags"
AION_FLAG_DEFAULT = "flags/flag_HK.png"  # fallback asset path for Dash

def aion_flag_asset(country_code: str | None) -> str:
    """
    Returns the Dash asset path for a flag given an ISO2 code (e.g., 'AE', 'KR').
    Falls back to AION_FLAG_DEFAULT if missing/invalid.
    """
    code = (country_code or "").strip().upper()
    if not code or len(code) != 2:
        return AION_FLAG_DEFAULT

    fname = f"flag_{code}.png"
    if (AION_FLAG_DIR / fname).exists():
        return f"flags/{fname}"

    return AION_FLAG_DEFAULT

import os
def column_header_row():
    return html.Div(
        style={
            "display": "grid",
            "gridTemplateColumns": "56px 1.6fr 1fr 1fr 1fr 112px",
            "gap": "12px",
            "padding": "6px 0 10px 0",
            "fontSize": "11px",
            "fontWeight": 700,
            "letterSpacing": "0.12em",
            "color": "#94a3b8",
            "textTransform": "uppercase",
        },
        children=["", "Runner", "Theo", "Fixed", "Exchange", "+EV"],
    )
from dash import Dash, html

app = Dash(__name__, assets_folder=os.path.abspath(os.path.join(os.path.dirname(__file__), "..", "assets")))
app.title = "Project Aion — Glass Cockpit"

def race_btn(n: int):
    return html.Button(
        str(n),
        style={
            "width": "34px",
            "height": "34px",
            "borderRadius": "8px",
            "border": "1px solid #e5e7eb",
            "background": "#ffffff",
            "color": "#334155",
            "fontWeight": 800,
            "fontSize":"10px",
            "lineHeight": "34px",
            "padding": "0",
            "cursor": "pointer",
        },
    )

def runner_btn(n: int):
    return html.Button(
        str(n),
        style={
            "width": "44px",
            "height": "44px",
            "borderRadius": "12px",
            "border": "1px solid #e5e7eb",
            "background": "#ffffff",
            "color": "#0f172a",
            "fontWeight": 900,
            "fontSize": "14px",
            "lineHeight": "44px",
            "padding": "0",
            "cursor": "pointer",
        },
    )

def weather_icon():
    return html.Div(
        "☀︎",
        title="Weather (placeholder)",
        style={
            "width": "40px",
            "height": "40px","width":"80px",
            "borderRadius": "10px",
            "border": "1px solid #e5e7eb",
            "display":"flex","justifyContent":"center",
            "alignItems": "center",
            "justifyContent": "center",
            "fontSize": "18px",
            "color": "#475569",
        },
    )

def column_header_row():
    return html.Div(
        style={
            "display": "grid",
            "gridTemplateColumns": "56px 1.6fr 1fr 1fr 1fr 112px",
            "gap": "12px",
            "padding": "6px 0 10px 0",
            "fontSize": "11px",
            "fontWeight": 700,
            "letterSpacing": "0.12em",
            "color": "#94a3b8",
            "textTransform": "uppercase",
        },
        children=["", "Runner", "Theo", "Fixed", "Exchange", "+EV"],
    )
# __AION_ELLIPSIS_HELPER__
def aion_ellipsis(s: str | None, max_len: int = 24) -> str:
    s = "" if s is None else str(s)
    if max_len <= 0:
        return ""
    if len(s) <= max_len:
        return s
    # use a single ellipsis char
    return s[: max_len - 1] + "…"
# __AION_UPCOMING_RACES__
# Placeholder feed. Later this becomes your upcoming race data module.
upcoming_races = [
    {"country_code": "HK", "track_code": "SHAT", "race_no": 1, "ttm_min": 18},
    {"country_code": "AE", "track_code": "MEYD", "race_no": 3, "ttm_min": 42},
    {"country_code": "GB", "track_code": "ASCOT", "race_no": 6, "ttm_min": 61},
    {"country_code": "FR", "track_code": "DEAUV", "race_no": 2, "ttm_min": 77},
]

def aion_track_code(code: str | None, n: int = 5) -> str:
    s = "" if code is None else str(code).upper().strip()
    return (s[:n]).ljust(min(n, 5)) if s else "-----"

def aion_ttm_label(ttm_min) -> str:
    try:
        m = float(ttm_min)
    except Exception:
        return ""
    if m < 0:
        return "OFF"
    if m < 1:
        return "<1m"
    return f"{int(round(m))}m"

AION_TILE_STYLE = {
    "position": "relative",
    "minWidth":"111px",
    "height":"34px",
    "borderRadius": "14px",
    "border": "1px solid #e5e7eb",
    "background": "#f8fafc",
    "padding":"6px 10px",
    "boxShadow": "0 6px 18px rgba(0,0,0,0.06)",
    "display": "flex",
    "flexDirection": "column",
    "justifyContent": "center",
}

def aion_upcoming_tile(r: dict):
    cc = (r.get("country_code") or "HK").upper()
    trk = aion_track_code(r.get("track_code"), 5)
    rn = r.get("race_no", "")
    ttm = aion_ttm_label(r.get("ttm_min"))

    return html.Div(
        style=AION_TILE_STYLE,
        children=[
            # flag top-right
            html.Img(
                src=app.get_asset_url(aion_flag_asset(cc)),
                style={
                    "position": "absolute",
                    "top":"6px",
                    "right": "10px",
                    "height":"12px",
                    "width":"22px",
                    "borderRadius": "4px",
                    "objectFit": "contain",
                    "boxShadow": "0 2px 6px rgba(0,0,0,0.12)",
                    "background": "transparent",
                },
            ),
            html.Div(
                f"{trk}  R{rn}",
                style={
                    "fontSize":"11px",
                    "fontWeight": 950,
                    "letterSpacing": "0.08em",
                    "color": "#111827",
                    "lineHeight": "1.1",
                },
            ),
            html.Div(
                f"T-{ttm}" if ttm else "",
                style={
                    "marginTop": "4px",
                    "fontSize": "12px",
                    "fontWeight": 900,
                    "letterSpacing": "0.10em",
                    "color": "#2563eb",
                },
            ),
        ],
    )


app.layout = html.Div(
    style={
        "background": "#f6f7fb",
        "minHeight": "100vh",
        "fontFamily": "system-ui",
        "paddingBottom": "72px",
    },
    children=[
        # ================= HEADER REALM =================
        html.Div(
            style={
                "background": "#ffffff",
                "borderRadius": "24px",
                "minHeight": "180px",
                "padding": "12px 28px 16px 28px",
                "margin": "16px",
                "boxShadow": "0 10px 26px rgba(0,0,0,0.08)",
            },
            children=[
                html.Div(
                    style={
                        "display": "flex",
                        "alignItems": "center",
                        "justifyContent": "space-between",
                        "flexWrap": "nowrap",
                    },
                    children=[
                        html.Div(
                            style={"display": "flex", "alignItems": "center", "gap": "10px"},
                            children=[
                                html.Div("", style={"fontSize": "34px"}),
                                html.Div([html.Div(html.Img(src=app.get_asset_url(aion_flag_asset(country_code)), style={"height":"100%","width":"100%","objectFit":"cover","display":"block"}), style={"marginLeft":"-14px","height":"28px","width":"56px","borderRadius":"6px","marginRight":"10px","boxShadow":"0 2px 8px rgba(0,0,0,0.18)","overflow":"hidden","display":"inline-block"})], style={"color":"#2563eb","fontWeight":900,"display":"flex","alignItems":"center","gap":"6px","lineHeight":"28px"}),
                                html.Div(aion_ellipsis(track_name, 18), style={"fontSize":"22px","fontWeight":950,"width":"18ch","flex":"0 0 18ch","whiteSpace":"nowrap","overflow":"hidden","textOverflow":"ellipsis","display":"block","minWidth":0}),
                                weather_icon(),
                                html.Div(
                                    style={"display": "flex", "gap": "6px"},
                                    children=[race_btn(i) for i in range(1, 11)],
                                ),
                            ],
                        ),
                        html.Div(
                            style={'display':'flex','flexDirection':'column','alignItems':'center','justifyContent':'center','gap':'2px'},
                            children=[
                                html.Div(aion_status_label(race_status), style={'fontSize':'14px','fontWeight':900,'letterSpacing':'0.14em','color':'#2563eb','textAlign':'center'}),
                                html.Div(
                                    style={'display':'flex','alignItems':'center','justifyContent':'flex-end','gap':'12px','minWidth':0},
                                    children=[
                                    html.Div(
                                        # Upcoming races (max 6) — immediately left of status/version
                                        style={
                                            'display':'flex',
                                            'gap':'10px',
                                            'alignItems':'center',
                                            'justifyContent':'flex-end',
                                            'maxWidth':'620px',
                                            'overflowX':'auto',
                                            'overflowY':'hidden',
                                            'whiteSpace':'nowrap',
                                            'WebkitOverflowScrolling':'touch',
                                        },
                                        children=[aion_upcoming_tile(r) for r in (upcoming_races or [])[:6]],
                                    ),
                                    html.Div(AION_UI_VERSION, style={'fontSize':'12px','fontWeight':800,'letterSpacing':'0.06em','color':'#6b7280','textAlign':'center'}),
                                                                ],
                                    ],
                                ),
                        ),
                    ],
                ),
            ],
        ),


        # ================= RUNNER REALM =================
        html.Div(
            style={
                "background": "#ffffff",
                "margin": "0 16px",
                "borderRadius": "18px",
                "padding": "12px 16px 16px 16px",
                "boxShadow": "0 6px 18px rgba(0,0,0,0.05)",
            },
            children=[
                # Step 3 — column header row
                column_header_row(),

                # Runner rows (placeholders only)
                *[
                    html.Div(
                        style={
                            "display": "grid",
                            "gridTemplateColumns": "56px 1.6fr 1fr 1fr 1fr 112px",
                            "gap": "12px",
                            "padding": "10px 0",
                        },
                        children=[
                            html.Div(
                                runner_btn(i),
                                style={
                                    "display": "flex",
                                    "alignItems": "center",
                                    "justifyContent": "center",
                                },
                            ),
                            "", "", "", "", "",
                        ],
                    )
                    for i in range(1, 15)
                ],
            ],
        ),

        # ================= FIXED BOTTOM BAR =================
        html.Div(
            style={
                "position": "fixed",
                "bottom": "0",
                "left": "0",
                "right": "0",
                "height": "64px",
                "background": "#ffffff",
                "borderTop": "1px solid #e5e7eb",
                "display": "flex",
                "alignItems": "center",
                "justifyContent": "flex-end",
                "padding": "0 24px",
            },
            children=[
                html.Div("AION CONTROL BAR (buttons later)", style={"color": "#64748b"}),
            ],
        ),
    ],
)

if __name__ == "__main__":
    app.run(host="127.0.0.1", port=8051, debug=False)